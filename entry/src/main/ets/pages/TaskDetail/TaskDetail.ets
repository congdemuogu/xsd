import { CommonRouterParams, HmCard, HmNavBar, HmSkeleton, HmToggleCard, HmUpload, UploadFile } from '@hm/basic'
import { promptAction, router } from '@kit.ArkUI'
import { deliverAPI, getTaskDetailAPI, pickUpAPI } from '../../api/task'
import { ExceptionListModel, TaskDetailInfoModel } from '../../models/task_detail'
import { HmLoading } from '@hm/basic/src/main/ets/components/HmLoading'
import { TaskTypeEnum } from '../../models'
import { uploadImageAPI } from '@hm/basic/src/main/ets/api/upload'
import common from '@ohos.app.ability.common'
import call from '@ohos.telephony.call'
import { worker } from '@kit.ArkTS'


// å…¨å±€çš„Extend æ‹“å±• æ–‡å­—çš„é¢œè‰²
@Extend(Text)
function baseTextIconStyle() {
  .fontSize(12)
  .fontColor($r('app.color.white'))
  .backgroundColor($r('app.color.text_primary'))
  .width(22)
  .height(22)
  .borderRadius(11)
  .textAlign(TextAlign.Center)
}

@Extend(Text)
function baseTextStyle() {
  .margin({ left: 11.5 })
  .fontColor($r('app.color.text_secondary'))
  .fontSize(14)
  .lineHeight(20)
}

class BaseBuilderClass {
  title: string = ""
  value: string = ""
  icon?: ResourceStr = ""
  iconClick?: () => void = () => {
  }
}


@Entry
@Component
struct TaskDetail {
  @State taskDetailData: TaskDetailInfoModel = {} as TaskDetailInfoModel

  async aboutToAppear() {
    await this.getTaskDetail()
  }

  async onPageShow() {
    const params = router.getParams() as CommonRouterParams
    if (params.addExcept) {
      await this.getTaskDetail()
    }
  }

  private async getTaskDetail() {
    const params = router.getParams() as CommonRouterParams
    if (params.id) {
      this.loading.open()
      const result = await getTaskDetailAPI(params.id)
      this.taskDetailData = result
      this.loading.close()
    }
  }

  @Builder
  getBaseContentItem(item: BaseBuilderClass) {
    Row() {
      Text(item.title).fontSize(14).fontColor($r('app.color.text_secondary'))
        .lineHeight(20)
      Row() {
        Text(item.value).fontSize(14).fontColor($r('app.color.text_secondary'))
        if (item.icon) {
          Image(item.icon).width(24).height(24)
            .onClick(() => {
              item.iconClick && item.iconClick()
            })
        }
      }
    }.justifyContent(FlexAlign.SpaceBetween).width('100%').margin({
      top: 14
    })
  }

  beginNav() {
    const context = getContext() as common.UIAbilityContext

    context.startAbility({
      action: 'ohos.want.action.viewData',
      entities: ['entity.system.browsable'], // æ‹‰èµ·çª—å£è¿›å…¥åˆ°é¸¿è’™æ‰‹æœºçš„è‡ªå¸¦æµè§ˆå™¨app
      uri: encodeURI('https://gaode.com/search?query=' + this.taskDetailData.endAddress) // å‘Šè¯‰æµè§ˆå™¨è¦è®¿é—®çš„åœ°å€
    }) // æ‹‰èµ·ä¸€ä¸ªæ–°çš„çª—å£
  }

  // è·å–åŸºç¡€ä¿¡æ¯
  @Builder
  getBaseInfo() {
    Row() {
      Column() {
        Row() {
          Text("èµ·").baseTextIconStyle()
          Text(this.taskDetailData.startAddress).baseTextStyle()
        }.margin({ top: 21 })

        Row() {
          Text("æ­¢").baseTextIconStyle().backgroundColor($r('app.color.primary'))
          Text(this.taskDetailData.endAddress).baseTextStyle()
        }.margin({ top: 14.5 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ right: 20 })


      if (this.taskDetailData.status === TaskTypeEnum.Line) {
        Column() {
          Image($r("app.media.ic_navigation")).width(22).height(22)
          Text("å¼€å§‹å¯¼èˆª").fontSize(14).margin({ top: 10, bottom: 10 })
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({
          top: 20
        })
        .onClick(() => {
          this.beginNav()
        })
      }


    }.justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center).width('100%')

    Divider().vertical(false).height(2).color($r('app.color.background_divider')).margin({ left: 8, right: 8, top: 21 })

    this.getBaseContentItem({
      title: 'ä»»åŠ¡ç¼–å·',
      value: this.taskDetailData.transportTaskId
    })
    this.getBaseContentItem({
      title: 'è”ç³»äºº',
      value: this.taskDetailData.startHandoverName
    })
    this.getBaseContentItem({
      title: 'è”ç³»ç”µè¯',
      value: this.taskDetailData.startHandoverPhone,
      icon: $r('app.media.ic_phone'),
      iconClick: () => {
        call.makeCall(this.taskDetailData.startHandoverPhone)
      }

    })
    this.getBaseContentItem({
      title: 'æè´§æ—¶é—´',
      value: this.taskDetailData.planDepartureTime
    })
    this.getBaseContentItem({
      title: 'é¢„è®¡é€è¾¾æ—¶é—´',
      value: this.taskDetailData.planArrivalTime
    })

  }

  @Builder
  getDriverInfo() {
    this.getBaseContentItem({
      title: 'è½¦ç‰Œå·',
      value: this.taskDetailData.licensePlate
    })

    this.getBaseContentItem({
      title: 'å¸æœºå§“å',
      value: this.taskDetailData.driverName
    })
  }

  // è¿è¾“è·¯çº¿
  @Builder
  getTransLineContent() {
    Row() {
      Column() {
        Text(this.taskDetailData.startProvince)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(22)
          .fontWeight(600)
        Text(this.taskDetailData.startCity).fontSize(14).lineHeight(22)
      }.width(50)

      Image($r("app.media.ic_right_arrow")).width(36).height(16)
      Column() {
        Text(this.taskDetailData.endProvince)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(22)
          .fontWeight(600)
        Text(this.taskDetailData.endCity).fontSize(14).lineHeight(22)
      }.width(50)
    }.justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center).width('100%').padding({
      left: 60,
      right: 60
    })
  }

  /** æè´§æ—¶ä¸Šä¼ ç»„ä»¶ */
  @Builder
  getPickUpInfo() {
    HmUpload({
      canUpload: this.taskDetailData.status === TaskTypeEnum.Waiting,
      title: 'è¯·æ‹ç…§ä¸Šä¼ å›å•å‡­è¯',
      imageList: this.taskDetailData.cargoPickUpPictureList || [],
      onImageListChange: (imageList) => {
        this.taskDetailData.cargoPickUpPictureList = imageList
      }
    })
    HmUpload({
      canUpload: this.taskDetailData.status === TaskTypeEnum.Waiting,
      title: 'è¯·æ‹ç…§ä¸Šä¼ è´§ç‰©ç…§ç‰‡å‡­è¯',
      imageList: this.taskDetailData.cargoPictureList || [],
      onImageListChange: (imageList) => {
        this.taskDetailData.cargoPictureList = imageList
      }

    })
  }

  scroller = new Scroller()
  loading = new CustomDialogController({
    builder: HmLoading(),
    customStyle: true
  })

  async onPickUp() {
    this.loading.open()
    /** ä¸Šä¼ åçš„å›¾ç‰‡åœ°å€æ•°ç»„ */
    const cargoPickUpPictureList = await UploadFile(this.taskDetailData.cargoPickUpPictureList)
    const cargoPictureList = await UploadFile(this.taskDetailData.cargoPictureList)
    // è°ƒç”¨æè´§çš„æ¥å£
    await pickUpAPI({
      id: this.taskDetailData.id,
      cargoPickUpPictureList: cargoPickUpPictureList,
      cargoPictureList: cargoPictureList
    })

    this.loading.close()

    //  åˆ·æ–°ç•Œé¢
    this.getTaskDetail()
    this.scroller.scrollEdge(Edge.Top) // æ§åˆ¶æ»šåŠ¨æ¡åˆ°é¡¶éƒ¨
    promptAction.showToast({ message: 'æè´§æˆåŠŸ' })
  }

  getPickUpEnable() {

    const cargoPickUpPictureList = this.taskDetailData.cargoPickUpPictureList || []
    const cargoPictureList = this.taskDetailData.cargoPictureList || []
    if (cargoPickUpPictureList.length > 0 && cargoPictureList.length > 0) {
      return true
    } else {
      return false
    }
  }

  // åº•éƒ¨æŒ‰é’®ç»“æ„
  @Builder
  getBottomBtn() {
    Row() {
      if (this.taskDetailData.status === TaskTypeEnum.Waiting) {
        Button("å»¶è¿Ÿæ”¶è´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.btn_gray'))
          .fontColor($r('app.color.text_primary'))
          .fontSize(16)
          .height(50)
          .width(125)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Delay/Delay',
              params: {
                id: this.taskDetailData.id,
                oldTime: this.taskDetailData.planDepartureTime
              }
            })
          })

        Button("æè´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.primary'))
          .fontColor($r('app.color.white'))
          .height(50)
          .flexGrow(1)
          .margin({ left: 13 })
          .enabled(this.getPickUpEnable())
          .onClick(() => {
            this.onPickUp()
          })

        //   äº¤è´§çš„é€»è¾‘
      } else if (this.taskDetailData.status === TaskTypeEnum.Line) {
        Button("ä¸ŠæŠ¥å¼‚å¸¸", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.btn_gray'))
          .fontColor($r('app.color.text_primary'))
          .fontSize(16)
          .height(50)
          .width(125)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Exception/ExceptionReport',
              params: {
                id: this.taskDetailData.transportTaskId
              }
            })
          })
        Button("äº¤è´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.primary'))
          .fontColor($r('app.color.white'))
          .height(50)
          .flexGrow(1)
          .margin({ left: 13 })
          .enabled(this.getDeliverEnable())
          .onClick(() => {
            this.onDeliver() // è°ƒç”¨äº¤è´§æ¥å£
          })

      } else if (this.taskDetailData.status === TaskTypeEnum.Delivered) {
        Row() {
          // å·²äº¤ä»˜æ˜¾ç¤ºå›è½¦ç™»è®°
          Button("å›è½¦ç™»è®°", { type: ButtonType.Capsule })
            .backgroundColor($r('app.color.primary'))
            .fontColor($r('app.color.white'))
            .height(50)
            .width('80%')
            .onClick(() => {
              router.pushUrl({
                url: 'pages/CarRecord/CarRecord',
                params: {
                  id: this.taskDetailData.id
                }
              })
            })
        }
        .width('100%').justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .padding({ left: 15, right: 15 })
    .height(70)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
    .backgroundColor($r('app.color.white'))


    //å·²å®Œæˆä¸æ˜¾ç¤ºä»»ä½•æŒ‰é’®

  }

  // äº¤è´§çš„é€»è¾‘
  // æ˜¾ç¤ºäº¤è´§çš„ä¸Šä¼ ç»„ä»¶
  @Builder
  getDeliverContent() {
    HmUpload({
      canUpload: this.taskDetailData.status === TaskTypeEnum.Line,
      title: 'è¯·æ‹ç…§ä¸Šä¼ äº¤è´§å›å•å‡­è¯',
      imageList: this.taskDetailData.certificatePictureList || [],
      onImageListChange: (imageList) => {
        this.taskDetailData.certificatePictureList = imageList
      }
    })
    HmUpload({
      canUpload: this.taskDetailData.status === TaskTypeEnum.Line,
      title: 'è¯·æ‹ç…§ä¸Šä¼ äº¤è´§è´§å“ç…§ç‰‡',
      imageList: this.taskDetailData.deliverPictureList || [],
      onImageListChange: (imageList) => {
        this.taskDetailData.deliverPictureList = imageList
      }

    })
  }

  // æ§åˆ¶äº¤è´§æŒ‰é’®æ˜¯å¦å¯ä»¥è¢«ç‚¹å‡»
  getDeliverEnable() {
    if (this.taskDetailData.deliverPictureList?.length > 0 && this.taskDetailData.certificatePictureList?.length > 0) {
      return true
    } else {
      return false
    }
  }

  // è°ƒç”¨æ¥å£, æ‰§è¡Œäº¤è´§
  async onDeliver() {

    // çº¿ç¨‹æ¨¡å—
    // è¦å¸¦ä¸Šæ–‡ä»¶çš„åç¼€
    const uploadWorker = new worker.ThreadWorker("entry/ets/workers/UploadWorker.ets") // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹

    // è®©ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹å‘æ¶ˆæ¯
    uploadWorker.postMessage({
      // ğŸ’¥ä¸å…è®¸ä¼ éå¯åºåˆ—åŒ–çš„æ•°æ®, å¸¦è£…é¥°å™¨çš„æ•°æ®, ä¸èƒ½ä¼ ç»™å­çº¿ç¨‹
      files: [...this.taskDetailData.certificatePictureList]
    })


    // // å…ˆæŠŠå›¾ç‰‡ä¸Šä¼ åˆ°åœ¨çº¿åœ°å€ä¸Š
    // const certificatePictureList = await UploadFile(this.taskDetailData.certificatePictureList)
    // const deliverPictureList = await UploadFile(this.taskDetailData.deliverPictureList)
    // this.loading.open()
    // await deliverAPI({
    //   certificatePictureList: certificatePictureList,
    //   deliverPictureList: deliverPictureList,
    //   id: this.taskDetailData.id
    // })
    // this.loading.close()
    // promptAction.showToast({ message: 'äº¤è´§æˆåŠŸ' })
    // this.getTaskDetail()
  }

  // è·å–å¼‚å¸¸ä¿¡æ¯
  @Builder
  getExceptionContent() {
    ForEach(this.taskDetailData.exceptionList, (item: ExceptionListModel) => {
      Row() {
        Column() {
          Row() {
            Text("ä¸ŠæŠ¥æ—¶é—´").fontSize(14).fontColor($r('app.color.text_primary'))
            Text(item.exceptionTime).margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')

          Row() {
            Text("å¼‚å¸¸ç±»å‹").fontSize(14).fontColor($r('app.color.text_primary'))
            Text(item.exceptionType).margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')

          Row() {
            Text("å¤„ç†ç»“æœ").fontSize(14).fontColor($r('app.color.text_primary'))
            Text("ç»§ç»­è¿è¾“").margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')
        }

        // è·³è½¬åˆ°è¯¦æƒ…
        Image($r("app.media.ic_btn_more")).width(24).height(24)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Exception/ExceptionDetail',
              params: {
                formData: item
              }
            })
          })
      }
      .width('100%')
      .padding({ left: 15, right: 15 })
      .alignItems(VerticalAlign.Center)
      .justifyContent(FlexAlign.SpaceBetween)

    })
  }

  build() {
    if (this.taskDetailData.id) {
      Column() {
        HmNavBar({ title: 'ä»»åŠ¡è¯¦æƒ…' })

        Scroll(this.scroller) {
          Column() {
            // åŸºæœ¬ä¿¡æ¯
            HmToggleCard({ title: 'åŸºæœ¬ä¿¡æ¯' }) {
              this.getBaseInfo()
            }

            HmToggleCard({ title: 'è½¦è¾†å¸æœºä¿¡æ¯' }) {
              this.getDriverInfo()
            }

            HmToggleCard({ title: 'è¿è¾“è·¯çº¿' }) {
              this.getTransLineContent()
            }

            if (this.taskDetailData.status === TaskTypeEnum.Waiting ||
              this.taskDetailData.status === TaskTypeEnum.Delivered) { // æè´§çŠ¶æ€æ˜¾ç¤ºæè´§ä¿¡æ¯
              HmToggleCard({ title: 'æè´§ä¿¡æ¯' }) {
                this.getPickUpInfo()
              }
            }

            if (this.taskDetailData.status === TaskTypeEnum.Line ||
              this.taskDetailData.status === TaskTypeEnum.Delivered) { // äº¤è´§çŠ¶æ€æ˜¾ç¤ºäº¤è´§ä¿¡æ¯
              HmToggleCard({ title: 'äº¤è´§ä¿¡æ¯' }) {
                this.getDeliverContent()
              }
            }


            //   æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯
            if (this.taskDetailData.status === TaskTypeEnum.Line) {
              HmToggleCard({ title: 'å¼‚å¸¸ä¿¡æ¯' }) {
                this.getExceptionContent()
              }
            }

          }
        }
        .layoutWeight(1)


        this.getBottomBtn()


      }
      .backgroundColor($r('app.color.background_page')).height('100%')
    } else {
      HmSkeleton({ showAvatar: false, count: 4 })
    }
  }
}