import { abilityAccessCtrl, AbilityConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { AdvertClass, defaultAd, TOKEN_KEY, UserSettingClass } from '@hm/basic';
import { accessibility } from '@kit.AccessibilityKit';

// éœ€æ±‚: æ ¹æ®ç”¨æˆ·æœ‰æ— token, è‡ªåŠ¨åŠ è½½é¦–é¡µæˆ–è€…ç™»å½•é¡µé¢
// 1. æ–°å»ºç™»å½•é¡µé¢
// 2. å‡†å¤‡å·¥ä½œ tokenä¿å­˜çš„key
// 3. ç»Ÿä¸€å¯¼å‡º
// 4. å°è£…ä¸¤ä¸ªå‡½æ•°: å­˜token  è·å–token
// 5. æ ¹æ®tokenæ˜¯å¦å­˜åœ¨åˆ¤æ–­, æ˜¾ç¤ºå“ªä¸ªé¡µé¢

// é¢å‘å¯¹è±¡-ä¸‰å¤§ç‰¹æ€§: å°è£…\ç»§æ‰¿\å¤šæ€
export default class EntryAbility extends UIAbility {
  async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam) {
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onCreate');

    //   å‘ç”¨æˆ·ä¸»åŠ¨ç”³è¯·æƒé™
    const mgr = abilityAccessCtrl.createAtManager()
    await mgr.requestPermissionsFromUser(this.context, [
      "ohos.permission.LOCATION",
      "ohos.permission.APPROXIMATELY_LOCATION"
    ])


  }

  onDestroy(): void {
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onDestroy');
  }

  async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {


    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageCreate');


    const ad = await new Promise<AdvertClass>((resolve) => {
      setTimeout(() => {
        resolve(defaultAd) // artTSè¿›é˜¶  resolve è¡¨ç¤ºæˆåŠŸçš„è¿”å›å€¼
      }, 500)
    })

    // å­˜åˆ°ç”¨æˆ·çš„æŒä¹…åŒ–å­˜å‚¨ä¸­
    const userSetting = new UserSettingClass(this.context)
    userSetting.setAdvert(ad)

    // å¦‚æœè¦æ˜¾ç¤ºå¹¿å‘Š-ä¸èƒ½ç›´æ¥æ˜¾ç¤ºé¦–é¡µ
    if (ad.showAd) {

      const win = await windowStage.createSubWindow('ad_window')
      await win.showWindow() // æ‰“å¼€å­çª—å£
      win.setUIContent('pages/Start/Start') // æ˜¾ç¤ºé‚£ä¸ªé¡µé¢çš„å†…å®¹åšä¸ºå­çª—å£çš„é¡µé¢
    }

    const token = userSetting.getToken()
    AppStorage.setOrCreate(TOKEN_KEY, token) // ğŸ’¥ğŸ’¥æ¯æ¬¡æ‰“å¡å¯åŠ¨é¡µæ—¶, è®°å¾—æŠŠtokenä»é¦–é€‰ä¸­åŒæ­¥åˆ°APpStorageä¸­
    if (token) {
      windowStage.loadContent('pages/Index/Index');
    } else {
      windowStage.loadContent('pages/Login/Login');
    }


  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onForeground');
  }

  onBackground(): void {
    // Ability has back to background
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onBackground');
  }
}
