@Preview
@Component
struct HmList {
  @State loading: boolean = false // è¡¨ç¤ºæ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸‹ä¸€é¡µæ•°æ®
  @State refreshing: boolean = false
  // ğŸ’¥ä¸èƒ½å†™æ­», å¤–éƒ¨ä¼ 
  @Prop finished: boolean = false // æœåŠ¡å™¨ä¸Šæ²¡æœ‰æ›´å¤šæ•°æ®äº†
  // ğŸ’¥taskListä¸èƒ½å†™æ­», å¤–éƒ¨ä¼ 
  @Prop dataSource: object[] = []
  // ğŸ’¥ğŸ’¥onLoad ä¸èƒ½å†™æ­», çˆ¶ç»„ä»¶ä¼ å…·ä½“å‘è¯·æ±‚çš„å«ç³Š
  onLoad: () => void = () => {
  }
  onRefresh: () => void = () => {
  }
  @Prop finishedText: string = 'æ²¡æœ‰æ›´å¤šæ•°æ®äº†'
  @Prop loadingText: string = 'æ‹¼å‘½åŠ è½½ä¸­'
  @BuilderParam
  renderItem: (item: object) => void

  getRefreshText() {
    switch (this.status) {
      case RefreshStatus.Inactive:
        return ''
      case RefreshStatus.Drag:
        return 'ç»§ç»­ä¸‹æ‹‰'

      case RefreshStatus.OverDrag:
        return 'æ¾æ‰‹åˆ·æ–°'
      case RefreshStatus.Refresh:
        return 'åˆ·æ–°ä¸­'
      default:
        return ''
    }
  }

  @Builder
  getRefreshBuilder() {
    // æ§åˆ¶ æ˜¾ç¤ºä¸åŒçš„æ–‡å­—, è‡ªå®šä¹‰æ–‡å­—æç¤ºçš„
    Row({ space: 10 }) {
      LoadingProgress()
        .color($r('app.color.primary'))
        .width(40)
        .height(40)
      Text(this.getRefreshText())
        .fontColor($r('app.color.text_secondary'))
        .fontSize(14)
    }
    .justifyContent(FlexAlign.Center)
    .height(50)
    .width('100%')
  }

  @State status: RefreshStatus = RefreshStatus.Inactive

  @Builder
  getBottom() {
    Row({ space: 10 }) {
      if (this.finished) {
        // æ­¤æ—¶åº”è¯¥æ²¡æœ‰åŠ¨ç”»çš„loading
        Text(this.finishedText)
          .fontSize(14)
          .fontColor($r("app.color.text_secondary"))
      } else {
        Text(this.loadingText)
          .fontSize(14)
          .fontColor($r("app.color.text_secondary"))
        LoadingProgress()
          .width(20)
          .aspectRatio(1)
          .color($r("app.color.text_secondary"))
      }
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)

  }

  build() {
    Refresh({ refreshing: $$this.refreshing, builder: this.getRefreshBuilder }) {
      List() {
        // è™šæ‹Ÿåˆ—è¡¨
        ForEach(this.dataSource, (item: object) => {
          ListItem() {
            // TaskItemCard({ taskItem: item }) // æ’æ§½ BuilderParams
            this.renderItem(item)
          }
        })

        ListItem() {
          this.getBottom()
        }

      }
      .onReachEnd(async () => {
        if (this.loading) {
          return
        }

        if (this.finished) {
          return
        }

        this.loading = true
        await this.onLoad()
        this.loading = false
      })
    }
    .onStateChange(async (state) => {
      this.status = state
      //  æ¯æ¬¡ä¸‹æ‹‰åˆ·æ–°å‰, è¦æŠŠæ—§çš„æ•°æ®é‡ç½®æ‰
      await this.onRefresh() // å†æ¬¡è¯·æ±‚ç¬¬ä¸€é¡µæ•°æ®
      this.refreshing = false
    })
  }
}

export default HmList
