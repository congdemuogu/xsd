import { picker } from '@kit.CoreFileKit'
import { HmPreview } from '.'
import { ImageListModel } from '../models'
import fs from '@ohos.file.fs'
import { util } from '@kit.ArkTS'
import { uploadImageAPI } from '../api/upload'
import request from '@ohos.request'

// å®ç°æè´§åŠŸèƒ½
// 1. å­ç»„ä»¶æ¯æ¬¡é€‰ä¸­äº†å›¾ç‰‡, æŠŠé€‰ä¸­çš„å›¾ç‰‡, ä¼ ç»™çˆ¶ç»„ä»¶TaskDetail
// 2. æ ¹æ®å›¾ç‰‡çš„æ•°é‡, ç¦ç”¨æè´§æŒ‰é’®
// 3. ç‚¹å‡»äº‹ä»¶ä¸­, å…ˆè°ƒç”¨ä¸Šä¼ æ¥å£
// 4. è°ƒç”¨æè´§çš„æ¥å£

@Component
export struct HmUpload {
  title: string = ""
  maxSelectNumber: number = 3
  @Prop imageList: ImageListModel[] = []
  onImageListChange: (imageList: ImageListModel[]) => void = () => {
  }

  async onSelect() {
    //   ä¸Šä¼ å›¾ç‰‡:  âœ…1. æ‰“å¼€ç›¸å†Œ-é€‰æ‹©å›¾ç‰‡  3. è°ƒç”¨ä¸Šä¼ çš„APIæ¥å£

    const photoPicker = new picker.PhotoViewPicker()

    // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆä¹Ÿä¼šæœ‰è¿”å›å€¼, è¿”å›æ˜¯å¯¹è±¡ {photoUris: ['urlåœ°å€', 'urlåœ°å€2']  } ç›¸å†Œä¸­å›¾ç‰‡çš„urlåœ°å€
    const result = await photoPicker.select({
      //   æœ€å¤§é€‰æ‹©æ•°é‡
      maxSelectNumber: this.maxSelectNumber - this.imageList.length,
      MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE
      //   é€‰æ‹©æ–‡ä»¶ç±»å‹: å›¾ç‰‡  è§†é¢‘
    })


    if (result.photoUris.length > 0) {
      const list = result.photoUris.map(item => {
        return { url: item } as ImageListModel
      })

      this.imageList.push(...list) // æ‹¼æ¥åˆ°æ—§æ•°ç»„ä¸­

      this.onImageListChange(this.imageList)
    }


  }

  index: number = 0
  controller = new CustomDialogController({
    builder: HmPreview({
      urls: this.imageList.map(item => item.url), // ç®­å¤´å‡½æ•°çš„æ–¹æ³•ä½“åªæœ‰ä¸€è¡Œæ—¶, å¯ä»¥çœç•¥{} å’Œ return
      selectedIndex: this.index
    }),
    customStyle: true
  })

  build() {

    Column() {
      Text(this.title).fontSize(14).fontColor($r("app.color.text_secondary")).margin({
        top: 16,
        bottom: 16
      })
      Grid() {

        ForEach(this.imageList, (item: ImageListModel, index) => {
          GridItem() {
            Stack({ alignContent: Alignment.TopEnd }) {
              Image(item.url)
                .width(95)
                .height(95)
                .onClick(() => {
                  this.index = index
                  this.controller.open()
                })
              Image($r('app.media.ic_btn_delete'))
                .width(30)
                .height(30)
                .onClick(() => {
                  this.imageList.splice(index, 1)
                  this.onImageListChange(this.imageList)
                })
            }

          }
        })

        if (this.imageList.length < this.maxSelectNumber) {
          GridItem() {
            Row() {
              Image($r("app.media.ic_add_img")).width(30).height(30)
            }
            .width(95)
            .height(95)
            .backgroundColor('#F2F2F2')
            .alignItems(VerticalAlign.Center)
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              this.onSelect()
            })
          }
        }


      }

    }
    .alignItems(HorizontalAlign.Start).width('100%')
  }
}


// å°è£…æˆä¸€ä¸ªå¯ä»¥æœç”¨çš„æ–¹æ³•, å¤–éƒ¨ä½¿ç”¨ä¸Šä¼ é€»è¾‘æ—¶, ç›´æ¥å¯¼å…¥è¯¥å‡½æ•°, å³å¯ä½¿ç”¨
export function UploadFile(imageList: ImageListModel[]): Promise<ImageListModel[]> {
  //   ğŸ’¥ğŸ’¥ è€ƒæœ¬æ–‡ä»¶åˆ°ç¼“å­˜ç›®å½•
  const saveDir = getContext().cacheDir // ç¼“å­˜ç›®å½•


  // è°ƒç”¨ä¸Šä¼ APIçš„å‚æ•°
  const fileList: request.File[] = []


  // AlertDialog.show({ message: targetPath, alignment: DialogAlignment.Center })
  imageList.forEach(item => {

    const fileName = util.generateRandomUUID()

    const targetPath = saveDir + '/' + fileName + '.jpg'
    const file = fs.openSync(item.url)
    // 2. æ‹·è´å›¾ç‰‡åˆ°æ²™ç®±(ä¸´æ—¶ç¼“å­˜ç›®å½•)
    fs.copyFileSync(file.fd, targetPath) //  æ‹·è´æ–‡ä»¶ : 1.åŸå§‹æ–‡ä»¶çš„åœ°å€æˆ–è€…id,  2.æ‹·è´åˆ°çš„åœ°å€æˆ–id

    fileList.push({
      filename: fileName + '.jpg',
      name: 'file',
      uri: `internal://cache/${fileName}.jpg`,
      type: 'jpg'
    })
  })


  return uploadImageAPI(getContext(), fileList)
}